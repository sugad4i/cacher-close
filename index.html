<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>キャッシャー集計 ver4.5</title>
<style>
 body{font-family:monospace;margin:20px}
 #head{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ccc;padding-bottom:8px}
 table{border-collapse:collapse;margin-top:16px}
 th,td{border:1px solid #aaa;padding:4px 8px}
 th{background:#eee}
 #big{white-space:pre;margin-top:20px}
 #copy{padding:8px 20px;font-size:16px}
</style>
</head>
<body>

<div id="head">
  <h1>キャッシャー集計 ver4.5</h1>
  <span id="upd"></span>
</div>

<input type="file" id="csv" accept=".csv">

<table id="tbl">
  <thead><tr><th>カテゴリ / 商品名</th><th>人数</th></tr></thead>
  <tbody></tbody>
</table>

<h3>コピー用本文</h3>
<div id="big"></div>
<button id="copy" onclick="copyTxt()">コピー</button>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
/* util */
document.getElementById('upd').textContent = '更新 ' + new Date().toLocaleDateString();
const tbody = document.querySelector('#tbl tbody');
const norm  = s => s.replace(/22~1/g, '22-1')
                    .replace(/[ \u3000\t]+/g, ' ')
                    .trim();

/* 集計用 */
let list = [], door = 0, fdoor = 0, doorLate = 0, fdoorLate = 0;
let total = 0, foreign = 0, male = 0, female = 0;
const shop = {};

/* CSV 読み込み */
document.getElementById('csv').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  file.arrayBuffer().then(buf => {
    const txt = new TextDecoder('shift-jis').decode(buf);
    Papa.parse(txt, { header: true, skipEmptyLines: true, complete: res => {
      parseCSV(res.data);
      buildTable();
      buildBig();
    }});
  });
});

/* 解析 */
function parseCSV(rows) {
  list = []; door = fdoor = doorLate = fdoorLate = 0;
  total = foreign = male = female = 0;
  Object.keys(shop).forEach(k => delete shop[k]);

  const cntCol = rows[0] && Object.keys(rows[0]).find(k => k.replace(/\s/g, '').includes('販売商品数'));
  const map = new Map();

  rows.forEach(row => {
    const cat  = norm(row['カテゴリー'] || '');
    const name = norm(row['商品名']    || '');
    const n    = +row[cntCol] || 0;
    if (!n) return;

    /* ―― カテゴリー「その他」は完全スキップ ―― */
    if (cat === 'その他') return;

    /* Door 集計 */
    if (cat === 'ローカル男性' || cat === 'ローカル女性')            door      += n;
    if (cat === '観光 男性'   || cat === '観光 女性' || cat === '観光') fdoor     += n;
    if (cat === '22-1 男性'   || cat === '22-1 女性')                 doorLate  += n;
    if (cat === '22-1 観光')                                           fdoorLate+= n;

    /* テーブル用 */
    const label = cat || name;
    map.set(label, (map.get(label) || 0) + n);

    /* 全体人数 */
    total += n;
    if (cat.includes('観光') || cat.includes('外国人')) foreign += n;
    if (cat.includes('男性')) male += n;
    else if (cat.includes('女性')) female += n;

    /* 店舗ゲスト/フリー */
    const m = name.match(/^(.+?)(ゲスト|フリー)/);
    if (m) {
      const s = m[1].trim();
      shop[s] = shop[s] || { guest: 0, free: 0 };
      if (m[2] === 'ゲスト') shop[s].guest += n;
      else                   shop[s].free  += n;
    }
  });

  /* map → list 配列化（フリー行保持）*/
  if (!map.has('フリー')) map.set('フリー', 0);
  list = [...map.entries()].map(([label, cnt]) => ({ label, cnt }))
                           .sort((a, b) => key(a.label).localeCompare(key(b.label), 'ja') ||
                                           a.label.localeCompare(b.label, 'ja'));
}

/* 並びキー：22-1 → 通常 → フリー */
function key(lbl) {
  if (lbl.startsWith('22-1')) return '0' + lbl;
  if (lbl.includes('フリー')) return '2' + lbl;
  return '1' + lbl;
}

/* テーブル描画 */
function buildTable() {
  tbody.innerHTML = '';
  list.forEach(o => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${o.label}</td><td>${o.cnt}</td>`;
    tbody.appendChild(tr);
  });
}

/* 本文生成 */
function buildBig() {
  let txt = 'キャッシャー〆\n\n';
  txt += `総数:${total}(外国人${foreign}名)\n`;
  txt += `M:${male} W:${female}\n\n`;
  txt += `Door                :  ${door.toString().padStart(4)}\n`;
  txt += `外国人Door             :  ${fdoor.toString().padStart(4)}\n`;
  txt += `22:00-1:00 Door     :  ${doorLate.toString().padStart(4)}\n`;
  txt += `22:00-1:00 外国人Door  :  ${fdoorLate.toString().padStart(4)}\n\n`;

  txt += '【店舗ゲスト/フリー】\n';
  Object.keys(shop).forEach(s => {
    const g = shop[s].guest || 0, f = shop[s].free || 0;
    txt += `${s}\n　${g + f}(ゲスト${g}フリー${f})\n`;
  });

  document.getElementById('big').textContent = txt;
}

/* コピー */
function copyTxt() {
  navigator.clipboard.writeText(document.getElementById('big').textContent)
    .then(() => alert('コピー完了！'))
    .catch(() => alert('コピー失敗…'));
}
</script>
</body>
</html>