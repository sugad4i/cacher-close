<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>キャッシャー集計 ver0.56</title>
<style>
 body{font-family:monospace;margin:20px}
 #head{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ccc;padding-bottom:8px}
 table{border-collapse:collapse;margin-top:14px;width:100%}
 th,td{border:1px solid #aaa;padding:4px 8px}
 th{background:#eee}
 input[type=number]{width:70px;text-align:right}
 #summary{white-space:pre;margin-top:18px}
 #yenBox{font-size:20px;font-weight:bold;margin-top:8px}
 #tplBox{margin-top:10px}
 #tplBox button{margin-right:8px}
</style>
</head>
<body>

<div id="head">
  <h1>キャッシャー集計 ver0.56</h1>
  <span id="upd"></span>
</div>

<input type="file" id="csv" accept=".csv">

<div id="tplBox">
  <strong>単価テンプレ:</strong>
  <button onclick="applyTpl('ARGO')">ARGO / WAYUP</button>
  <button onclick="applyTpl('ENCORE')">ENCORE / LOYAL</button>
</div>

<table id="tbl">
  <thead>
    <tr><th>カテゴリ / 商品名</th><th>人数</th><th>単価(円)</th></tr>
  </thead>
  <tbody></tbody>
</table>

<div id="summary"></div>
<div id="yenBox">合計金額: <span id="yenTotal">0</span> 円</div>

<button id="copy" onclick="copyTxt()">コピー</button>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
/* ===== util ===== */
document.getElementById('upd').textContent =
  '更新 ' + new Date().toLocaleDateString()

const tbody   = document.querySelector('#tbl tbody')
const summary = document.getElementById('summary')
const yenSpan = document.getElementById('yenTotal')
const norm = s => s.replace(/22~1/g,'22-1').replace(/[ \u3000\t]+/g,' ').trim()

/* ===== 並べ替えテーブル ===== */
const order22 = [
  '22-1 ローカル男性',
  '22-1 ローカル女性',
  '22-1 男性',
  '22-1 女性',
  '22-1 ローカル男性ゲスト',
  '22-1 ローカル女性ゲスト',
  '22-1 男性ゲスト',
  '22-1 女性ゲスト',
  '22-1 ローカルG男性ゲスト',
  '22-1 ローカルG女性ゲスト',
  '22-1 G男性ゲスト',
  '22-1 G女性ゲスト',
  '22-1 ローカルゲストG男性',
  '22-1 ローカルゲストG女性',
  '22-1 観光 男性',
  '22-1 観光 女性'
]

const orderNorm = [
  '男性',
  '女性',
  'ローカル男性',
  'ローカル女性',
  'ローカル男性ゲスト',
  'ローカル女性ゲスト',
  'ローカルゲスト男性',
  'ローカルゲスト女性',
  'ローカルG男性ゲスト',
  'ローカルG女性ゲスト',
  'ローカルゲストG男性',
  'ローカルゲストG女性',
  '観光 男性',
  '観光 女性'
]

function sKey(label){
  if(label.startsWith('22-1')){
    const i = order22.indexOf(label)
    return '0' + (i>=0 ? String(i).padStart(2,'0') : '99') + label
  }
  if(label.includes('フリー')) return '2'+label
  const j = orderNorm.indexOf(label)
  return '1' + (j>=0 ? String(j).padStart(2,'0') : '99') + label
}

/* ===== 単価テンプレ ===== */
const priceTpl = {

  ARGO : {
    /* 22-1 全て 500 */
    '22-1 ローカル男性':500,'22-1 ローカル女性':500,'22-1 男性':500,'22-1 女性':500,
    '22-1 ローカル男性ゲスト':500,'22-1 ローカル女性ゲスト':500,
    '22-1 男性ゲスト':500,'22-1 女性ゲスト':500,
    '22-1 ローカルG男性ゲスト':500,'22-1 ローカルG女性ゲスト':500,
    '22-1 G男性ゲスト':500,'22-1 G女性ゲスト':500,
    '22-1 ローカルゲストG男性':500,'22-1 ローカルゲストG女性':500,
    '22-1 観光 男性':500,'22-1 観光 女性':500,

    /* 通常 */
    '男性':2000,'女性':1000,'ローカル男性':2000,'ローカル女性':1000,
    'ローカル男性ゲスト':1500,'ローカル女性ゲスト':700,
    'ローカルゲスト男性':1500,'ローカルゲスト女性':700,
    'ローカルG男性ゲスト':1500,'ローカルG女性ゲスト':700,
    'ローカルゲストG男性':1500,'ローカルゲストG女性':700,
    '観光 男性':2000,'観光 女性':1000,

    /* 共通行 */
    'フリー':0,'再入場':500,'靴':1000
  },

  ENCORE : {
    /* 22-1 全て 500 */
    '22-1 ローカル男性':500,'22-1 ローカル女性':500,'22-1 男性':500,'22-1 女性':500,
    '22-1 ローカル男性ゲスト':500,'22-1 ローカル女性ゲスト':500,
    '22-1 男性ゲスト':500,'22-1 女性ゲスト':500,
    '22-1 ローカルG男性ゲスト':500,'22-1 ローカルG女性ゲスト':500,
    '22-1 G男性ゲスト':500,'22-1 G女性ゲスト':500,
    '22-1 ローカルゲストG男性':500,'22-1 ローカルゲストG女性':500,
    '22-1 観光 男性':500,'22-1 観光 女性':500,

    /* 通常 */
    '男性':2000,'女性':1000,'ローカル男性':2000,'ローカル女性':1000,
    'ローカル男性ゲスト':1500,'ローカル女性ゲスト':700,
    'ローカルゲスト男性':1500,'ローカルゲスト女性':700,
    'ローカルG男性ゲスト':1500,'ローカルG女性ゲスト':700,
    'ローカルゲストG男性':1500,'ローカルゲストG女性':700,
    '観光 男性':3000,'観光 女性':2000,

    'フリー':0,'再入場':500,'靴':1000
  }
}

/* ===== 集計変数 ===== */
let rows=[],total=0,foreign=0,male=0,female=0
let door=0,fdoor=0,doorLate=0,fdoorLate=0
const shop={}

/* ===== CSV 読込 ===== */
document.getElementById('csv').addEventListener('change',e=>{
  const file=e.target.files[0]
  if(!file) return
  const fr = new FileReader()
  fr.onload = ev=>{
    const txt = new TextDecoder('shift-jis').decode(ev.target.result)
    Papa.parse(txt,{header:true,skipEmptyLines:true,complete:r=>{
      parseCSV(r.data)
      buildTable()
      buildSummary()
      calcMoney()
    }})
  }
  fr.readAsArrayBuffer(file)
})

/* ===== 解析 ===== */
function parseCSV(data){
  rows=[]
  total=foreign=male=female=0
  door=fdoor=doorLate=fdoorLate=0
  Object.keys(shop).forEach(k=>delete shop[k])

  const cntCol=data[0]&&Object.keys(data[0]).find(k=>k.replace(/\s/g,'').includes('販売商品数'))
  const map = new Map()

  data.forEach(r=>{
    let cat = norm(r['カテゴリー']||'')
    const nm  = norm(r['商品名']||'')
    const n   = +r[cntCol]||0
    if(!n) return

    /* その他→商品名ラベル */
    if(cat==='その他') cat=nm

    /* 観光を男女分割 */
    if(cat==='観光')      cat+=' '+(nm.includes('女性')?'女性':'男性')
    if(cat==='22-1 観光') cat+=' '+(nm.includes('女性')?'女性':'男性')

    /* Door 集計 */
    if(['ローカル男性','ローカル女性','ローカルG男性','ローカルG女性'].includes(cat)) door+=n
    if(['観光 男性','観光 女性'].includes(cat))                                            fdoor+=n
    if(['22-1 男性','22-1 女性','22-1 ローカル男性','22-1 ローカル女性','22-1 ローカルG男性','22-1 ローカルG女性'].includes(cat)) doorLate+=n
    if(['22-1 観光 男性','22-1 観光 女性'].includes(cat))                                   fdoorLate+=n

    map.set(cat,(map.get(cat)||0)+n)

    if(nm.includes('男性')) male+=n
    else if(nm.includes('女性')) female+=n
    total+=n
    if(cat.includes('観光')||cat.includes('外国人')) foreign+=n

    const m=nm.match(/^(.+?)(ゲスト|フリー)/)
    if(m){
      const st=m[1].replace(/22-1/gi,'').trim()
      shop[st]=shop[st]||{guest:0,free:0,freeInp:0}
      if(m[2]==='ゲスト') shop[st].guest+=n
      else shop[st].free+=n
    }
  })

  if(!map.has('フリー')) map.set('フリー',0)

  rows=[...map.entries()].map(([label,cnt])=>({label,cnt}))
       .sort((a,b)=>sKey(a.label).localeCompare(sKey(b.label),'ja')||
                    a.label.localeCompare(b.label,'ja'))
}

/* ===== テーブル ===== */
function buildTable(){
  tbody.innerHTML=''
  rows.forEach(r=>{
    const id='pr_'+btoa(unescape(encodeURIComponent(r.label))).replace(/=+$/,'')
    const tr=document.createElement('tr')
    tr.innerHTML=
      `<td>${r.label}</td>`+
      `<td class="cnt">${r.cnt}</td>`+
      `<td><input type="number" id="${id}" value="0"></td>`
    tbody.appendChild(tr)
    document.getElementById(id).oninput=calcMoney
  })
}

/* ===== Summary ===== */
function buildSummary(){
  let h=''
  h+=`総数:${total}(外国人${foreign}名)\n`
  h+=`M:${male} W:${female}\n\n`
  h+=`Door                :    ${door}\n`
  h+=`外国人Door             :    ${fdoor}\n`
  h+=`22:00-1:00 Door     :    ${doorLate}\n`
  h+=`22:00-1:00 外国人Door  :    ${fdoorLate}\n\n`
  h+=`店ゲスト          <input type="number" id="sg" value="0">\n`
  h+=`店フリー           <input type="number" id="sf" value="0">\n\n`
  h+='【店舗ゲスト/フリー】\n'
  Object.keys(shop).forEach(s=>{
    const id=`fi_${btoa(unescape(encodeURIComponent(s))).replace(/=+$/,'')}`
    h+=`${s}\n　<span id="tot_${id}">${shop[s].guest+shop[s].free}</span>(ゲスト${shop[s].guest} フリー <input type="number" id="${id}" value="0"> )\n`
  })
  summary.innerHTML=h
  document.getElementById('sg').oninput=calcMoney
  document.getElementById('sf').oninput=calcMoney
  Object.keys(shop).forEach(s=>{
    const id=`fi_${btoa(unescape(encodeURIComponent(s))).replace(/=+$/,'')}`
    document.getElementById(id).oninput=e=>{
      shop[s].freeInp=+e.target.value||0
      document.getElementById(`tot_${id}`).textContent=
        shop[s].guest+shop[s].free+shop[s].freeInp
      calcMoney()
    }
  })
}

/* ===== テンプレ適用 ===== */
function applyTpl(name){
  const tpl=priceTpl[name]
  if(!tpl){alert('テンプレ未定義');return}
  tbody.querySelectorAll('tr').forEach(tr=>{
    const label=tr.children[0].textContent.trim()
    if(label in tpl){
      tr.querySelector('input').value=tpl[label]
    }
  })
  calcMoney()
}

/* ===== 金額計算 ===== */
function calcMoney(){
  let sum=0
  tbody.querySelectorAll('tr').forEach(tr=>{
    const cnt=+tr.querySelector('.cnt').textContent
    const p  =+tr.querySelector('input').value||0
    sum+=cnt*p
  })
  yenSpan.textContent=sum.toLocaleString()
}

/* ===== コピー ===== */
function copyTxt(){
  const sg=+document.getElementById('sg').value||0
  const sf=+document.getElementById('sf').value||0
  const amount=yenSpan.textContent.replace(/,/g,'')
  let txt='キャッシャー〆\n\n'
  txt+=`総数:${total}(外国人${foreign}名)\n`
  txt+=`M:${male} W:${female}\n\n`
  txt+=`Door                :    ${door}\n`
  txt+=`外国人Door             :    ${fdoor}\n`
  txt+=`22:00-1:00 Door     :    ${doorLate}\n`
  txt+=`22:00-1:00 外国人Door  :    ${fdoorLate}\n\n`
  txt+=`店ゲスト          ${sg}\n`
  txt+=`店フリー           ${sf}\n`
  txt+=`合計金額          ${amount} 円\n\n`
  txt+='【店舗ゲスト/フリー】\n'
  Object.keys(shop).forEach(s=>{
    const g=shop[s].guest
    const f=shop[s].free+shop[s].freeInp
    txt+=`${s}\n　${g+f}(ゲスト${g} フリー ${shop[s].freeInp})\n`
  })
  navigator.clipboard.writeText(txt)
    .then(()=>alert('コピー完了！'))
    .catch(()=>alert('コピー失敗…'))
}
</script>
</body>
</html>
