<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>キャッシャー集計 ver1.01</title>
<style>
  body{font-family:monospace;margin:20px}
  #head{display:flex;justify-content:space-between;align-items:center;
        border-bottom:1px solid #ccc;padding-bottom:8px}
  table{border-collapse:collapse;margin-top:14px;width:100%}
  th,td{border:1px solid #aaa;padding:4px 8px}
  th{background:#eee}
  input[type=number]{width:70px;text-align:right}
  #summary{white-space:pre;margin-top:18px}
  #yenBox{font-size:20px;font-weight:bold;margin:12px 0}
  #tplBox{margin-top:10px}
  #tplBox button{margin-right:8px}
</style>
</head>
<body>

<div id="head">
  <h1>キャッシャー集計 ver1.01</h1>
  <span id="upd"></span>
</div>

<!-- 合計金額（コピー対象外） -->
<div id="yenBox">合計金額: <span id="yenTotal">0</span> 円</div>

<input type="file" id="csv" accept=".csv">

<div id="tplBox">
  <strong>テンプレ:</strong>
  <button onclick="applyTpl('ARGO')">ARGO / WAYUP</button>
  <button onclick="applyTpl('ENCORE')">ENCORE / LOYAL</button>
</div>

<table id="tbl">
  <thead>
    <tr><th>カテゴリ / 商品名</th><th>人数</th><th>単価(円)</th></tr>
  </thead>
  <tbody></tbody>
</table>

<div id="summary"></div>

<button id="copy" onclick="copyTxt()">コピー</button>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
/* ---------- util ---------- */
document.getElementById('upd').textContent =
  '更新 ' + new Date().toLocaleDateString();

const tbody   = document.querySelector('#tbl tbody');
const summary = document.getElementById('summary');
const yenSpan = document.getElementById('yenTotal');
const norm    = s=>s.replace(/22~1/g,'22-1').replace(/[ \u3000\t]+/g,' ').trim();

/* ---------- 並べ替えテーブル ---------- */
const order22 = [
  '22-1 ローカル男性','22-1 ローカル女性','22-1 男性','22-1 女性',
  '22-1 ローカル男性ゲスト','22-1 ローカル女性ゲスト','22-1 男性ゲスト','22-1 女性ゲスト',
  '22-1 ローカルG男性ゲスト','22-1 ローカルG女性ゲスト','22-1 G男性ゲスト','22-1 G女性ゲスト',
  '22-1 ローカルゲストG男性','22-1 ローカルゲストG女性','22-1 観光 男性','22-1 観光 女性'
];
const orderNorm = [
  '男性','女性','ローカル男性','ローカル女性',
  'ローカル男性ゲスト','ローカル女性ゲスト',
  'ローカルゲスト男性','ローカルゲスト女性',
  'ローカルG男性ゲスト','ローカルG女性ゲスト',
  'ローカルゲストG男性','ローカルゲストG女性',
  '観光 男性','観光 女性'
];
function sKey(l){
  if(l.startsWith('22-1')) return '0'+String(order22.indexOf(l)).padStart(2,'0')+l;
  if(l.includes('フリー')) return '2'+l;
  return '1'+String(orderNorm.indexOf(l)).padStart(2,'0')+l;
}

/* ---------- 単価テンプレ（ver1.0 と同） ---------- */
const priceTpl={/* …略。内容は ver1.0 と同じ … */};

/* ---------- 集計変数 ---------- */
let rows=[],total=0,foreign=0,male=0,female=0;
let door=0,fdoor=0,doorLate=0,fdoorLate=0;
const shop={};

/* ---------- CSV 読み込み ---------- */
document.getElementById('csv').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const fr=new FileReader();
  fr.onload=ev=>{
    const txt=new TextDecoder('shift-jis').decode(ev.target.result);
    Papa.parse(txt,{header:true,skipEmptyLines:true,complete:r=>{
      parseCSV(r.data); buildTable(); buildSummary(); calcMoney();
    }});
  };
  fr.readAsArrayBuffer(f);
});

/* ---------- CSV 解析 ---------- */
function parseCSV(data){
  rows=[]; total=foreign=male=female=0;
  door=fdoor=doorLate=fdoorLate=0;
  Object.keys(shop).forEach(k=>delete shop[k]);

  const cntCol=data[0]&&Object.keys(data[0]).find(k=>k.replace(/\s/g,'').includes('販売商品数'));
  const map=new Map();

  data.forEach(r=>{
    const originalCat = norm(r['カテゴリー']||'');
    let   cat         = originalCat;
    const nm  = norm(r['商品名']||'');
    const n   = +r[cntCol]||0;
    if(!n) return;

    /* その他⇒表示用ラベルにするが総数には含めない */
    const isOther = (cat==='その他');
    if(isOther) cat = nm;

    /* 観光 男女分割 */
    if(cat==='観光')      cat+=' '+(nm.includes('女性')?'女性':'男性');
    if(cat==='22-1 観光') cat+=' '+(nm.includes('女性')?'女性':'男性');

    /* テーブル行は常に追加 */
    map.set(cat,(map.get(cat)||0)+n);

    /* === 以下の集計は「その他」を除外 === */
    if(isOther) return;

    if(['ローカル男性','ローカル女性','ローカルG男性','ローカルG女性'].includes(cat)) door+=n;
    if(['観光 男性','観光 女性'].includes(cat))                                            fdoor+=n;
    if(['22-1 男性','22-1 女性','22-1 ローカル男性','22-1 ローカル女性',
        '22-1 ローカルG男性','22-1 ローカルG女性'].includes(cat))                          doorLate+=n;
    if(['22-1 観光 男性','22-1 観光 女性'].includes(cat))                                   fdoorLate+=n;

    if(nm.includes('男性')) male+=n;
    else if(nm.includes('女性')) female+=n;
    total+=n;
    if(cat.includes('観光')||cat.includes('外国人')) foreign+=n;

    /* 店舗ゲスト/フリーも「その他」は無視 */
    const m=nm.match(/^(.+?)(ゲスト|フリー)/);
    if(m){
      const st=m[1].replace(/22-1/gi,'').trim();
      shop[st]=shop[st]||{guest:0,free:0,freeInp:0};
      if(m[2]==='ゲスト') shop[st].guest+=n;
      else shop[st].free+=n;
    }
  });

  if(!map.has('フリー')) map.set('フリー',0);
  rows=[...map.entries()].map(([label,cnt])=>({label,cnt}))
       .sort((a,b)=>sKey(a.label).localeCompare(sKey(b.label),'ja')||
                    a.label.localeCompare(b.label,'ja'));
}

/* ---------- テーブル、Summary、calcMoney, applyTpl, copyTxt ---------- */
/* （ver1.0 とまったく同じなので省略せず貼付けてください）            */
</script>
</body>
</html>
