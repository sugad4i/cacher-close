<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>キャッシャー集計 ver4.8</title>
<style>
 body{font-family:monospace;margin:20px}
 #head{display:flex;justify-content:space-between;align-items:center;
       border-bottom:1px solid #ccc;padding-bottom:8px}
 table{border-collapse:collapse;margin-top:16px}
 th,td{border:1px solid #aaa;padding:4px 8px}
 th{background:#eee}
 input[type=number]{width:70px;text-align:right}
 #big{white-space:pre;margin-top:20px}
 #copy{padding:8px 20px;font-size:16px}
 .inpBox{margin:6px 0}
</style>
</head>
<body>

<div id="head">
  <h1>キャッシャー集計 ver4.8</h1>
  <span id="upd"></span>
</div>

<input type="file" id="csv" accept=".csv">

<table id="tbl">
  <thead><tr><th>カテゴリ / 商品名</th><th>人数</th></tr></thead>
  <tbody></tbody>
</table>

<!-- 店ゲスト / 店フリー 自由入力 -->
<div class="inpBox">
  店ゲスト <input type="number" id="in_shopGuest" value="0">
  店フリー <input type="number" id="in_shopFree"  value="0">
</div>

<h3>コピー用本文</h3>
<div id="big"></div>
<button id="copy" onclick="copyTxt()">コピー</button>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
/* util */
document.getElementById('upd').textContent =
  '更新 ' + new Date().toLocaleDateString();
const tbody = document.querySelector('#tbl tbody');
const norm  = s => s.replace(/22~1/g,'22-1')
                    .replace(/[ \u3000\t]+/g,' ')
                    .trim();

/* 並びキー：22-1 → 通常 → フリー */
const sortKey = lbl =>
  lbl.startsWith('22-1') ? '0'+lbl :
  lbl.includes('フリー') ? '2'+lbl : '1'+lbl;

/* 集計変数 */
let rows=[],door=0,fdoor=0,doorLate=0,fdoorLate=0;
let total=0,foreign=0,male=0,female=0;
const shop={};                // { name:{guest,free(auto),freeManual} }

/* CSV 読み込み */
document.getElementById('csv').addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file) return;
  file.arrayBuffer().then(buf=>{
    const txt=new TextDecoder('shift-jis').decode(buf);
    Papa.parse(txt,{header:true,skipEmptyLines:true,complete:r=>{
      parseCSV(r.data);
      buildTable();
      buildBig();
    }});
  });
});

/* 解析 */
function parseCSV(data){
  rows=[]; door=fdoor=doorLate=fdoorLate=0;
  total=foreign=male=female=0;
  Object.keys(shop).forEach(k=>delete shop[k]);

  const cntCol=data[0]&&Object.keys(data[0]).find(k=>k.replace(/\s/g,'').includes('販売商品数'));
  const map=new Map();

  data.forEach(row=>{
    const cat  = norm(row['カテゴリー']||'');
    const name = norm(row['商品名']||'');
    const n    = +row[cntCol]||0;
    if(!n) return;

    /* その他は無視 */
    if(cat==='その他') return;

    /* Door 集計 */
    if(['ローカル男性','ローカル女性','ローカルG男性','ローカルG女性'].includes(cat))
        door+=n;

    if(['観光 男性','観光 女性','観光'].includes(cat))
        fdoor+=n;

    /* 22-1 Door */
    if(['22-1 男性','22-1 女性',
        '22-1 ローカル男性','22-1 ローカル女性',
        '22-1 ローカルG男性','22-1 ローカルG女性'].includes(cat))
        doorLate+=n;

    /* 22-1 外国人Door */
    if(['22-1 観光','22-1 観光 男性','22-1 観光 女性'].includes(cat))
        fdoorLate+=n;

    /* テーブル行 */
    const label = cat || name;
    map.set(label,(map.get(label)||0)+n);

    /* M / W （商品名ベース） */
    if(name.includes('男性')) male+=n;
    else if(name.includes('女性')) female+=n;

    /* 全体人数・外国人 */
    total+=n;
    if(cat.includes('観光')||cat.includes('外国人')) foreign+=n;

    /* 店舗ゲスト/フリー */
    const m=name.match(/^(.+?)(ゲスト|フリー)/);
    if(m){
      const store=m[1].replace(/22-1/gi,'').trim();
      shop[store]=shop[store]||{guest:0,free:0,freeManual:0};
      if(m[2]==='ゲスト') shop[store].guest+=n;
      else                shop[store].free +=n;
    }
  });

  /* フリー行保証 */
  if(!map.has('フリー')) map.set('フリー',0);

  rows=[...map.entries()].map(([label,cnt])=>({label,cnt}))
                         .sort((a,b)=>sortKey(a.label).localeCompare(sortKey(b.label),'ja')||
                                      a.label.localeCompare(b.label,'ja'));
}

/* テーブル＋店舗フリー入力生成 */
function buildTable(){
  tbody.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.label}</td><td>${r.cnt}</td>`;
    tbody.appendChild(tr);
  });

  /* 店舗入力エリア */
  const area=document.createElement('div');
  area.id='shopBox';
  area.style.marginTop='12px';
  area.innerHTML='<h4>各店舗フリー入力</h4>';
  Object.keys(shop).forEach(store=>{
    const id='fm_'+btoa(unescape(encodeURIComponent(store))).replace(/=+$/,'');
    const inp=`<input type="number" id="${id}" value="0" style="width:70px">`;
    area.innerHTML+=`${store} フリー ${inp}<br>`;
  });
  tbody.parentNode.after(area);

  /* 入力ハンドラ */
  document.querySelectorAll('#shopBox input[type=number]').forEach(inp=>{
    inp.oninput=()=>{
      const store=decodeURIComponent(atob(inp.id.slice(3)));
      shop[store].freeManual=+inp.value||0;
      buildBig();
    };
  });

  /* グローバル店ゲスト/フリー入力 */
  document.getElementById('in_shopGuest').oninput=buildBig;
  document.getElementById('in_shopFree' ).oninput=buildBig;
}

/* 本文 */
function buildBig(){
  const gStore=+document.getElementById('in_shopGuest').value||0;
  const fStore=+document.getElementById('in_shopFree' ).value||0;

  let out='キャッシャー〆\n\n';
  out+=`総数:${total}(外国人${foreign}名)\n`;
  out+=`M:${male} W:${female}\n\n`;
  out+=`Door                :  ${door.toString().padStart(4)}\n`;
  out+=`外国人Door             :  ${fdoor.toString().padStart(4)}\n`;
  out+=`22:00-1:00 Door     :  ${doorLate.toString().padStart(4)}\n`;
  out+=`22:00-1:00 外国人Door  :  ${fdoorLate.toString().padStart(4)}\n\n`;
  out+=`店ゲスト          ${gStore}\n`;
  out+=`店フリー           ${fStore}\n\n`;

  out+='【店舗ゲスト/フリー】\n';
  Object.keys(shop).forEach(s=>{
    const g=shop[s].guest||0;
    const f=shop[s].free + shop[s].freeManual;
    out+=`${s}\n　${g+f}(ゲスト${g} フリー${shop[s].freeManual} )\n`;
  });

  document.getElementById('big').textContent=out;
}

/* コピー */
function copyTxt(){
  navigator.clipboard.writeText(document.getElementById('big').textContent)
    .then(()=>alert('コピー完了！')).catch(()=>alert('コピー失敗…'));
}

/* 店ゲスト/フリー入力ハンドラを先に付ける */
document.getElementById('in_shopGuest').oninput=buildBig;
document.getElementById('in_shopFree' ).oninput=buildBig;
</script>
</body>
</html>