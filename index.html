<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>キャッシャー集計 ver4.4</title>
<style>
 body{font-family:monospace;margin:20px}
 #head{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ccc;padding-bottom:8px}
 table{border-collapse:collapse;margin-top:16px}
 th,td{border:1px solid #aaa;padding:4px 8px}
 th{background:#eee}
 input[type=number]{width:90px;text-align:right}
 #total{margin:18px 0;font-size:22px;font-weight:bold;color:#c00}
 #big{white-space:pre;margin-top:20px}
 #copy{padding:8px 20px;font-size:16px}
</style>
</head>
<body>

<div id="head"><h1>キャッシャー集計 ver4.4</h1><span id="upd"></span></div>

<input type="file" id="csv" accept=".csv">

<table id="tbl"><thead>
  <tr><th>カテゴリ / 商品名</th><th>人数</th><th>単価 (円)</th></tr>
</thead><tbody></tbody></table>

<div id="total"></div>

<h3>コピー用本文</h3>
<div id="big"></div>
<button id="copy" onclick="copyTxt()">コピー</button>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
/* ───────── util ───────── */
const tbody=document.querySelector('#tbl tbody');
document.getElementById('upd').textContent='更新 '+new Date().toLocaleDateString();
const id=s=>'p_'+btoa(unescape(encodeURIComponent(s))).replace(/=+$/,'');
const norm=s=>s.replace(/22~1/g,'22-1').replace(/[ \u3000\t]+/g,' ').trim();

/* 行並びキー（22-1 → 通常 → フリー）*/
function key(lbl){
  if(lbl.startsWith('22-1')) return '0'+lbl;
  if(lbl.includes('フリー')) return '2'+lbl;
  return '1'+lbl;
}

/* ───────── 集計用変数 ───────── */
let list=[],door=0,fdoor=0,doorLate=0,fdoorLate=0;
let bigTotal=0,foreign=0,male=0,female=0;
const shop={};

/* ───────── CSV 読み込み ───────── */
document.getElementById('csv').addEventListener('change',e=>{
 const f=e.target.files[0]; if(!f) return;
 new Response(f).arrayBuffer().then(buf=>{
  const txt=new TextDecoder('shift-jis').decode(buf);
  Papa.parse(txt,{header:true,skipEmptyLines:true,complete:r=>{
    parseCSV(r.data);
    buildTable();
    calc();
  }});
 });
});

/* ───────── パーサ ───────── */
function parseCSV(rows){
 list=[]; door=fdoor=doorLate=fdoorLate=0;
 bigTotal=foreign=male=female=0;
 Object.keys(shop).forEach(k=>delete shop[k]);

 const cntCol=rows[0]&&Object.keys(rows[0]).find(k=>k.replace(/\s/g,'').includes('販売商品数'));
 const map=new Map();

 rows.forEach(row=>{
   const cat  = norm(row['カテゴリー']||'');
   const name = norm(row['商品名']   ||'');
   const n    = +row[cntCol]||0; if(!n) return;

   /* ── カテゴリー「その他」は完全無視 ── */
   if(cat==='その他') return;

   /* ── Door / 外国人Door ── */
   if(cat==='ローカル男性' || cat==='ローカル女性'){
       door += n;
       if(cat.startsWith('22~1')) doorLate += n;          // 無いはずだが保険
   }
   if(cat==='観光 男性' || cat==='観光 女性' ){
       fdoor += n;
       if(cat.startsWith('22~1')) fdoorLate += n;        // 観光に 22-1 付きが来た時用
   }

   /* ── 22-1 Door / 外国人Door ── */
   if(cat==='22~1 男性' || cat==='22~1 女性'){
       doorLate += n;
   }
   if(cat==='22-1 観光'){
       fdoorLate += n;
   }

   /* テーブル用行集計 */
   const label = cat || name;
   map.set(label,(map.get(label)||0)+n);

   /* 本文用総計 */
   bigTotal += n;
   if(cat.includes('外国人')||cat.startsWith('観光')) foreign += n;
   if(cat.includes('男性')) male += n;
   else if(cat.includes('女性')) female += n;

   const m=name.match(/^(.+?)(ゲスト|フリー)/);
   if(m){
     const s=m[1].trim();
     shop[s]=shop[s]||{guest:0,free:0};
     if(m[2]==='ゲスト') shop[s].guest+=n;
     else shop[s].free+=n;
   }
 });

 /* フリー行を必ず持つ */
 if(!map.has('フリー')) map.set('フリー',0);

 list=[...map.entries()].map(([label,cnt])=>({label,cnt,priceId:label.includes('フリー')?null:id(label)}))
                        .sort((a,b)=>key(a.label).localeCompare(key(b.label),'ja')||
                                     a.label.localeCompare(b.label,'ja'));
}



/* ───────── 本文生成 ───────── */
function buildBig(sum){
 let txt='キャッシャー〆\n\n';
 txt+=`総数:${bigTotal}(外国人${foreign}名)\n`;
 txt+=`M:${male} W:${female}\n\n`;
 txt+=`Door                :  ${door.toString().padStart(4)}\n`;
 txt+=`外国人Door             :  ${fdoor.toString().padStart(4)}\n`;
 txt+=`22:00-1:00 Door     :  ${doorLate.toString().padStart(4)}\n`;
 txt+=`22:00-1:00 外国人Door  :  ${fdoorLate.toString().padStart(4)}\n\n`;

 txt+='【店舗ゲスト/フリー】\n';
 Object.keys(shop).forEach(s=>{
   const g=shop[s].guest||0,f=shop[s].free||0;
   txt+=`${s}\n　${g+f}(ゲスト${g}フリー${f})\n`;
 });

 txt+=`\n合計金額:${sum.toLocaleString()}円`;
 document.getElementById('big').textContent=txt;
}

/* ───────── コピー ───────── */
function copyTxt(){
 navigator.clipboard.writeText(document.getElementById('big').textContent)
  .then(()=>alert('コピー完了！')).catch(()=>alert('コピー失敗…'));
}
</script>
</body>
</html>